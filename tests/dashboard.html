<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevFlow Test Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #3b82f6;
            margin-bottom: 10px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .status-card {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #3b82f6;
        }
        
        .status-card.healthy {
            border-left-color: #10b981;
        }
        
        .status-card.warning {
            border-left-color: #f59e0b;
        }
        
        .status-card.error {
            border-left-color: #ef4444;
        }
        
        .status-card h3 {
            margin-bottom: 15px;
            color: #f1f5f9;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-weight: bold;
        }
        
        .metric-value.healthy {
            color: #10b981;
        }
        
        .metric-value.warning {
            color: #f59e0b;
        }
        
        .metric-value.error {
            color: #ef4444;
        }
        
        .chart-container {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chart {
            height: 200px;
            background: #0f172a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
        }
        
        .logs {
            background: #1e293b;
            border-radius: 8px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            margin-bottom: 5px;
            padding: 5px;
            background: #0f172a;
            border-radius: 3px;
        }
        
        .log-entry.error {
            background: #7f1d1d;
        }
        
        .log-entry.success {
            background: #14532d;
        }
        
        .log-entry.warning {
            background: #78350f;
        }
        
        .refresh-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            background: #2563eb;
        }
        
        .timestamp {
            color: #64748b;
            font-size: 12px;
        }
        
        .health-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .health-indicator.healthy {
            background: #10b981;
        }
        
        .health-indicator.warning {
            background: #f59e0b;
        }
        
        .health-indicator.error {
            background: #ef4444;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 DevFlow Test Dashboard</h1>
            <p>Real-time system health monitoring and test results</p>
            <button class="refresh-btn" onclick="loadData()">🔄 Refresh Data</button>
            <div class="timestamp" id="lastUpdate">Last updated: Never</div>
        </div>
        
        <div class="status-grid">
            <div class="status-card" id="overallHealth">
                <h3>Overall System Health</h3>
                <div class="metric">
                    <span>Health Score:</span>
                    <span class="metric-value" id="healthScore">--</span>
                </div>
                <div class="metric">
                    <span>Critical Services:</span>
                    <span class="metric-value" id="criticalHealth">--</span>
                </div>
                <div class="metric">
                    <span>Test Runs:</span>
                    <span class="metric-value" id="testRuns">--</span>
                </div>
            </div>
            
            <div class="status-card" id="infrastructure">
                <h3>📊 Infrastructure</h3>
                <div id="infraServices"></div>
            </div>
            
            <div class="status-card" id="applications">
                <h3>🔧 Application Services</h3>
                <div id="appServices"></div>
            </div>
            
            <div class="status-card" id="integration">
                <h3>🔗 Integration Tests</h3>
                <div id="integrationTests"></div>
            </div>
        </div>
        
        <div class="chart-container">
            <h3>📈 Health Trend (Last 24 Hours)</h3>
            <div class="chart" id="healthChart">
                Health trend chart will be displayed here
            </div>
        </div>
        
        <div class="logs">
            <h3>📋 Recent Activity</h3>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        let currentData = null;
        let historyData = [];
        
        async function loadData() {
            try {
                // Load current test results
                const response = await fetch('./test-results.json');
                if (response.ok) {
                    currentData = await response.json();
                }
                
                // Load historical data
                const historyResponse = await fetch('./global-test-history.json');
                if (historyResponse.ok) {
                    historyData = await historyResponse.json();
                }
                
                updateDashboard();
                document.getElementById('lastUpdate').textContent = 
                    `Last updated: ${new Date().toLocaleTimeString()}`;
                    
            } catch (error) {
                console.error('Failed to load data:', error);
                showError('Failed to load test data. Make sure tests have been run.');
            }
        }
        
        function updateDashboard() {
            if (!currentData) return;
            
            updateOverallHealth();
            updateInfrastructure();
            updateApplications();
            updateIntegration();
            updateLogs();
        }
        
        function updateOverallHealth() {
            const infraUp = Object.values(currentData.infrastructure || {})
                .filter(s => s.status === 'RUNNING').length;
            const servicesHealthy = Object.values(currentData.services || {})
                .filter(s => s.status === 'HEALTHY').length;
            const integrationWorking = Object.values(currentData.integration || {})
                .filter(s => s.status === 'WORKING').length;
                
            const total = Object.keys(currentData.infrastructure || {}).length +
                         Object.keys(currentData.services || {}).length +
                         Object.keys(currentData.integration || {}).length;
                         
            const healthPercentage = total > 0 ? 
                Math.round(((infraUp + servicesHealthy + integrationWorking) / total) * 100) : 0;
            
            const healthScore = document.getElementById('healthScore');
            healthScore.textContent = `${healthPercentage}%`;
            healthScore.className = `metric-value ${getHealthClass(healthPercentage)}`;
            
            document.getElementById('criticalHealth').textContent = `${healthPercentage}%`;
            document.getElementById('testRuns').textContent = currentData.runCount || 0;
            
            const card = document.getElementById('overallHealth');
            card.className = `status-card ${getHealthClass(healthPercentage)}`;
        }
        
        function updateInfrastructure() {
            const container = document.getElementById('infraServices');
            container.innerHTML = '';
            
            Object.entries(currentData.infrastructure || {}).forEach(([name, data]) => {
                const metric = document.createElement('div');
                metric.className = 'metric';
                metric.innerHTML = `
                    <span><span class="health-indicator ${getHealthClass(data.status === 'RUNNING' ? 100 : 0)}"></span>${name}</span>
                    <span class="metric-value ${getHealthClass(data.status === 'RUNNING' ? 100 : 0)}">${data.status}</span>
                `;
                container.appendChild(metric);
            });
        }
        
        function updateApplications() {
            const container = document.getElementById('appServices');
            container.innerHTML = '';
            
            Object.entries(currentData.services || {}).forEach(([name, data]) => {
                const metric = document.createElement('div');
                metric.className = 'metric';
                const responseTime = data.responseTime ? ` (${data.responseTime}ms)` : '';
                metric.innerHTML = `
                    <span><span class="health-indicator ${getHealthClass(data.status === 'HEALTHY' ? 100 : 0)}"></span>${name}</span>
                    <span class="metric-value ${getHealthClass(data.status === 'HEALTHY' ? 100 : 0)}">${data.status}${responseTime}</span>
                `;
                container.appendChild(metric);
            });
        }
        
        function updateIntegration() {
            const container = document.getElementById('integrationTests');
            container.innerHTML = '';
            
            Object.entries(currentData.integration || {}).forEach(([name, data]) => {
                const metric = document.createElement('div');
                metric.className = 'metric';
                metric.innerHTML = `
                    <span><span class="health-indicator ${getHealthClass(data.status === 'WORKING' ? 100 : 0)}"></span>${name}</span>
                    <span class="metric-value ${getHealthClass(data.status === 'WORKING' ? 100 : 0)}">${data.status}</span>
                `;
                container.appendChild(metric);
            });
        }
        
        function updateLogs() {
            const container = document.getElementById('logEntries');
            container.innerHTML = '';
            
            // Add recent fixes
            (currentData.fixes || []).slice(-5).forEach(fix => {
                const entry = document.createElement('div');
                entry.className = 'log-entry success';
                entry.textContent = `✅ ${fix}`;
                container.appendChild(entry);
            });
            
            // Add recent errors
            (currentData.errors || []).slice(-5).forEach(error => {
                const entry = document.createElement('div');
                entry.className = 'log-entry error';
                entry.textContent = `❌ ${error}`;
                container.appendChild(entry);
            });
            
            // Add timestamp
            if (currentData.timestamp) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = `📅 Test run completed at ${new Date(currentData.timestamp).toLocaleString()}`;
                container.appendChild(entry);
            }
            
            if (container.children.length === 0) {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.textContent = 'No recent activity';
                container.appendChild(entry);
            }
        }
        
        function getHealthClass(value) {
            if (typeof value === 'string') {
                return value === 'RUNNING' || value === 'HEALTHY' || value === 'WORKING' ? 'healthy' : 'error';
            }
            if (value >= 90) return 'healthy';
            if (value >= 70) return 'warning';
            return 'error';
        }
        
        function showError(message) {
            const container = document.getElementById('logEntries');
            container.innerHTML = `<div class="log-entry error">${message}</div>`;
        }
        
        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
        
        // Initial load
        loadData();
    </script>
</body>
</html>